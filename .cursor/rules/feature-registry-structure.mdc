---
description: Feature registry and auto-discovery for SFX theme
globs:
alwaysApply: false
---
# Feature registry (SFX child theme)

## Entry points
- `functions.php` boots autoloading, then `SFX\SFXBricksChildTheme->init()`.
- `inc/SFXBricksChildTheme.php` auto-discovers features and initializes them.

## Auto-discovery
- `auto_register_features()` scans `inc/*/Controller.php`.
- Each controller must implement `public static function get_feature_config(): array`.
- The registry key is the lowercased folder name (e.g., `ImageOptimizer` -> `imageoptimizer`).
- The registry is read via `SFXBricksChildTheme::get_registered_features()`.
- In admin, `AccessControl::can_access_theme_settings()` gates the registry (returns empty when denied).

## Initialization flow
- `load_dependencies()` instantiates each feature:
  - If `activation_option_name` + `activation_option_key` are set, the option must be truthy.
  - If `hook` is set, initialization is deferred to that hook.
  - If `callback` is provided, it is called with the class; otherwise `new $class()` is used.
- Consolidated hooks exist for feature initialization phases:
  - `sfx_init_core_features`, `sfx_init_post_types`, `sfx_init_settings`, `sfx_init_admin_features`, `sfx_init_advanced_features`.

## Feature config schema (current usage)
- `class` (string, required)
- `menu_slug`, `page_title`, `description` (strings, optional)
- `url` (string, optional) for CPT-based features
- `show_in_theme_settings` (bool, optional)
- `activation_option_name` + `activation_option_key` (strings, optional)
- `hook` (string|null, optional)
- `callback` (callable, optional)
- `error` (string, used for error_log on missing class)

## Current registered features (summary)
- `GeneralThemeOptions` (always on)
- `ImageOptimizer` (gated by `sfx_general_options.enable_image_optimizer`)
- `SecurityHeader` (gated by `sfx_general_options.enable_security_header`)
- `WPOptimizer` (gated by `sfx_general_options.enable_wp_optimizer`)
- `CustomDashboard` (AccessControl also restricts access to its settings UI)
- `HtmlCopyPaste` (feature-level enable flag in its options)
- `ImportExport` (theme settings import/export)
- `ContactInfos` (CPT-based, has Bricks dynamic tag `{contact_info:field}`)
- `SocialMediaAccounts` (CPT-based, shortcode)
- `CustomScriptsManager` (CPT-based, conditional script injection)
- `TextSnippets` (standalone; `show_in_theme_settings` false)
- `Shortcodes` (no menu; initializes on `acf/init`)