---
description: ImageOptimizer (PixRefiner) overview and behavior
globs: inc/ImageOptimizer/**
alwaysApply: false
---
# ImageOptimizer (PixRefiner) overview

## Location
- Core code: `inc/ImageOptimizer/` (`Controller`, `Settings`, `Ajax`, `ImageConversionService`, `FormatConverter`, `Constants`)
- Admin UI: `inc/ImageOptimizer/AdminPage.php` + assets in `inc/ImageOptimizer/assets/`

## Purpose
- Converts uploads and existing media to WebP or AVIF.
- Generates up to 4 size variants plus a 150x150 thumbnail.
- Optionally deletes originals, cleans up leftovers, and fixes URLs in content/meta.

## Settings (Options API, prefixed)
- `sfx_webp_max_widths`, `sfx_webp_max_heights`
- `sfx_webp_resize_mode` (`width` or `height`)
- `sfx_webp_quality` (0-100)
- `sfx_webp_batch_size`
- `sfx_webp_preserve_originals`
- `sfx_webp_disable_auto_conversion`
- `sfx_webp_min_size_kb`
- `sfx_webp_use_avif`
- `sfx_webp_excluded_images`
- `sfx_webp_conversion_log`
- Legacy options are migrated once by `Settings::migrate_legacy_options()`.

## Conversion flow
- Uploads: `wp_handle_upload` -> `Controller::handle_upload_convert_to_format()`.
- Batch: AJAX `webp_convert_single` -> `Ajax::convert_single_image()` -> `ImageConversionService`.
- Uses `ImageConversionService::convertImage()` to convert sizes and generate thumbnail.
- Metadata is updated via `ImageConversionService::updateAttachmentMetadata()`.
- Metadata stamp `pixrefiner_stamp` is used to detect whether reprocessing is needed.

## Key behaviors
- Limits intermediate sizes to `thumbnail` only when auto-conversion is enabled.
- Registers up to 3 additional custom sizes beyond the main size.
- Adds custom `srcset` entries for converted sizes.
- Disables big image scaling (`big_image_size_threshold`).
- Ensures WebP/AVIF MIME types in `.htaccess` on theme switch or format toggle.
- Exclusion list prevents conversion and cleanup for specific attachments.

## Safety and cleanup
- Rollback on conversion failure (delete generated files, keep original).
- Preserve originals when `sfx_webp_preserve_originals` is true or when restored.
- Cleanup runs in memory-aware batches to avoid timeouts.

## Hooks and AJAX surface
Actions (ImageConversionService):
- `sfx_image_before_convert`
- `sfx_image_after_convert`
- `sfx_image_conversion_failed`
- `sfx_image_before_delete_original`
- `sfx_image_after_thumbnail`

Filters:
- `sfx_image_quality`
- `sfx_image_max_values`
- `sfx_image_skip_conversion`
- `sfx_image_metadata`
- `sfx_image_should_delete_original`

AJAX endpoints (nonce `webp_converter_nonce`, capability `manage_options`):
- `webp_convert_single`
- `webp_add_excluded_image`, `webp_remove_excluded_image`, `webp_get_excluded_images`
- `webp_cleanup_originals`, `webp_cleanup_optimized`
- `webp_fix_post_image_urls`
- `webp_export_media_zip`
- Settings: `webp_set_max_widths`, `webp_set_max_heights`, `webp_set_min_size_kb`,
  `webp_set_quality`, `webp_set_batch_size`, `webp_set_use_avif`,
  `webp_set_preserve_originals`, `webp_set_disable_auto_conversion`
- `webp_revert_to_original`
